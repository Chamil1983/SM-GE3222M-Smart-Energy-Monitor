<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - SM-GE3222M</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>System Configuration</h1>
                <div class="header-controls">
                    <button id="themeToggle" class="btn-icon" aria-label="Toggle theme">
                        <span class="theme-icon">ðŸŒ™</span>
                    </button>
                    <a href="/index.html" class="btn-secondary">Dashboard</a>
                    <button id="logoutBtn" class="btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <div class="config-container">
            <form id="configForm">
                <input type="hidden" id="csrfToken" name="csrf_token" value="">

                <!-- WiFi Settings -->
                <div class="card config-section">
                    <h2>WiFi Settings</h2>
                    <div class="form-group">
                        <label for="wifiSsid">SSID *</label>
                        <input type="text" id="wifiSsid" name="wifi_ssid" required maxlength="32">
                    </div>
                    <div class="form-group">
                        <label for="wifiPassword">Password</label>
                        <input type="password" id="wifiPassword" name="wifi_password" autocomplete="off" maxlength="64">
                        <small>Leave blank to keep current password</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="wifiDhcp" name="wifi_dhcp">
                            Use DHCP
                        </label>
                    </div>
                    <div id="staticIpFields">
                        <div class="form-group">
                            <label for="wifiIp">Static IP Address</label>
                            <input type="text" id="wifiIp" name="wifi_ip" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" placeholder="192.168.1.100">
                        </div>
                        <div class="form-group">
                            <label for="wifiGateway">Gateway</label>
                            <input type="text" id="wifiGateway" name="wifi_gateway" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" placeholder="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label for="wifiSubnet">Subnet Mask</label>
                            <input type="text" id="wifiSubnet" name="wifi_subnet" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" placeholder="255.255.255.0">
                        </div>
                    </div>
                </div>

                <!-- MQTT Settings -->
                <div class="card config-section">
                    <h2>MQTT Settings</h2>
                    <div class="form-group">
                        <label for="mqttServer">MQTT Server *</label>
                        <input type="text" id="mqttServer" name="mqtt_server" required maxlength="128" placeholder="broker.example.com">
                    </div>
                    <div class="form-group">
                        <label for="mqttPort">Port *</label>
                        <input type="number" id="mqttPort" name="mqtt_port" required min="1" max="65535" value="1883">
                    </div>
                    <div class="form-group">
                        <label for="mqttUser">Username</label>
                        <input type="text" id="mqttUser" name="mqtt_user" maxlength="64" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="mqttPassword">Password</label>
                        <input type="password" id="mqttPassword" name="mqtt_password" maxlength="64" autocomplete="off">
                        <small>Leave blank to keep current password</small>
                    </div>
                    <div class="form-group">
                        <label for="mqttTopic">Topic Prefix</label>
                        <input type="text" id="mqttTopic" name="mqtt_topic" maxlength="64" placeholder="energy/monitor" value="energy/monitor">
                    </div>
                    <div class="form-group">
                        <label for="mqttInterval">Publish Interval (seconds)</label>
                        <input type="number" id="mqttInterval" name="mqtt_interval" min="1" max="3600" value="5">
                    </div>
                </div>

                <!-- Modbus RTU Settings -->
                <div class="card config-section">
                    <h2>Modbus RTU Settings</h2>
                    <div class="form-group">
                        <label for="modbusSlaveId">Slave ID</label>
                        <input type="number" id="modbusSlaveId" name="modbus_slave_id" min="1" max="247" value="1">
                    </div>
                    <div class="form-group">
                        <label for="modbusBaud">Baud Rate</label>
                        <select id="modbusBaud" name="modbus_baud">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modbusParity">Parity</label>
                        <select id="modbusParity" name="modbus_parity">
                            <option value="N">None</option>
                            <option value="E">Even</option>
                            <option value="O">Odd</option>
                        </select>
                    </div>
                </div>

                <!-- Modbus TCP Settings -->
                <div class="card config-section">
                    <h2>Modbus TCP Settings</h2>
                    <div class="form-group">
                        <label for="modbusTcpPort">Port</label>
                        <input type="number" id="modbusTcpPort" name="modbus_tcp_port" min="1" max="65535" value="502">
                    </div>
                    <div class="form-group">
                        <label for="modbusTcpMaxConn">Max Connections</label>
                        <input type="number" id="modbusTcpMaxConn" name="modbus_tcp_max_conn" min="1" max="10" value="4">
                    </div>
                </div>

                <!-- Calibration Settings -->
                <div class="card config-section">
                    <h2>Calibration Settings</h2>
                    <h3>Phase A</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voltageGainA">Voltage Gain</label>
                            <input type="number" id="voltageGainA" name="voltage_gain_a" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="currentGainA">Current Gain</label>
                            <input type="number" id="currentGainA" name="current_gain_a" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="voltageOffsetA">Voltage Offset</label>
                            <input type="number" id="voltageOffsetA" name="voltage_offset_a" step="0.01" min="-100" max="100" value="0.00">
                        </div>
                        <div class="form-group">
                            <label for="currentOffsetA">Current Offset</label>
                            <input type="number" id="currentOffsetA" name="current_offset_a" step="0.01" min="-10" max="10" value="0.00">
                        </div>
                    </div>

                    <h3>Phase B</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voltageGainB">Voltage Gain</label>
                            <input type="number" id="voltageGainB" name="voltage_gain_b" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="currentGainB">Current Gain</label>
                            <input type="number" id="currentGainB" name="current_gain_b" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="voltageOffsetB">Voltage Offset</label>
                            <input type="number" id="voltageOffsetB" name="voltage_offset_b" step="0.01" min="-100" max="100" value="0.00">
                        </div>
                        <div class="form-group">
                            <label for="currentOffsetB">Current Offset</label>
                            <input type="number" id="currentOffsetB" name="current_offset_b" step="0.01" min="-10" max="10" value="0.00">
                        </div>
                    </div>

                    <h3>Phase C</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voltageGainC">Voltage Gain</label>
                            <input type="number" id="voltageGainC" name="voltage_gain_c" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="currentGainC">Current Gain</label>
                            <input type="number" id="currentGainC" name="current_gain_c" step="0.0001" min="0" max="10" value="1.0000">
                        </div>
                        <div class="form-group">
                            <label for="voltageOffsetC">Voltage Offset</label>
                            <input type="number" id="voltageOffsetC" name="voltage_offset_c" step="0.01" min="-100" max="100" value="0.00">
                        </div>
                        <div class="form-group">
                            <label for="currentOffsetC">Current Offset</label>
                            <input type="number" id="currentOffsetC" name="current_offset_c" step="0.01" min="-10" max="10" value="0.00">
                        </div>
                    </div>
                    <button type="button" id="testCalibration" class="btn-secondary">Test Calibration</button>
                </div>

                <!-- System Settings -->
                <div class="card config-section">
                    <h2>System Settings</h2>
                    <div class="form-group">
                        <label for="logLevel">Logging Level</label>
                        <select id="logLevel" name="log_level">
                            <option value="0">Error</option>
                            <option value="1">Warning</option>
                            <option value="2">Info</option>
                            <option value="3">Debug</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="lcdAutoScroll" name="lcd_auto_scroll">
                            LCD Auto-scroll
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="ntpServer">NTP Server</label>
                        <input type="text" id="ntpServer" name="ntp_server" maxlength="64" placeholder="pool.ntp.org" value="pool.ntp.org">
                    </div>
                </div>

                <!-- Firmware Update -->
                <div class="card config-section">
                    <h2>Firmware Update</h2>
                    <div class="form-group">
                        <label for="firmwareFile">Firmware File (.bin)</label>
                        <input type="file" id="firmwareFile" name="firmware_file" accept=".bin">
                    </div>
                    <button type="button" id="uploadFirmware" class="btn-primary">Upload Firmware</button>
                    <div id="uploadProgress" class="progress-bar" style="display:none;">
                        <div class="progress-fill"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card config-section">
                    <h2>Actions</h2>
                    <div class="button-group">
                        <button type="submit" class="btn-primary">Save Configuration</button>
                        <button type="button" id="reloadConfig" class="btn-secondary">Reload</button>
                        <button type="button" id="factoryReset" class="btn-danger">Factory Reset</button>
                    </div>
                </div>
            </form>
        </div>

        <footer>
            <p>SM-GE3222M Smart Energy Monitor V2.0</p>
        </footer>
    </div>

    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="modal" style="display:none;">
        <div class="modal-content">
            <h3 id="confirmTitle">Confirm Action</h3>
            <p id="confirmMessage">Are you sure?</p>
            <div class="button-group">
                <button id="confirmYes" class="btn-danger">Yes</button>
                <button id="confirmNo" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
</body>
</html>
